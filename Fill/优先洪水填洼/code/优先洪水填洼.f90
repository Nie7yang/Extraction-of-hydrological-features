!◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇
!◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◆◆◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇
!◇◇◇◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◇◇◇◇◇◇◇◇◇◇◇◇◆◆◆◇◇◇◇◇◇◇◇◇◇◇◆◆◆◆◆◆◆◇◇◇◇◇◇◇◇◇◇◇◇
!◇◇◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◇◇◇◇◇◇◇◇◇◇◇◇◇◆◆◆◇◇◇◇◇◇◇◇◇◇◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◇◇
!◇◇◇◇◇◆◆◆◆◆◆◆◆◆◆◆◇◇◇◇◇◇◇◇◇◆◆◆◆◆◆◆◆◆◆◆◆◆◆◇◇◇◇◇◆◆◆◇◆◆◆◆◆◆◆◆◆◆◆◆◆◇◇
!◇◇◇◇◇◆◆◆◆◆◆◆◆◆◆◆◇◇◇◇◇◇◇◇◇◆◆◆◆◆◆◆◆◆◆◆◆◆◆◇◇◇◇◇◆◆◆◇◆◆◇◆◆◆◇◇◇◇◆◆◇◇◇
!◇◇◇◇◇◆◆◇◇◇◇◇◇◆◆◆◇◇◇◇◇◇◇◇◇◆◆◆◇◇◇◇◇◇◇◇◆◆◇◇◇◇◇◇◆◆◆◇◆◆◇◆◆◆◇◇◇◇◆◆◇◇◇
!◇◇◇◇◇◆◆◆◆◆◆◆◆◆◆◆◇◇◇◇◇◇◇◇◇◆◆◆◇◇◇◇◇◇◇◇◆◆◆◇◇◇◇◇◆◆◆◆◆◆◇◆◆◆◇◇◇◇◆◆◇◇◇
!◇◇◇◇◇◆◆◇◇◆◆◆◆◆◆◆◆◆◇◇◇◇◇◇◇◆◆◆◆◆◆◆◆◆◆◆◆◆◆◇◇◇◇◇◆◆◆◆◆◆◇◆◆◆◇◇◇◇◆◆◇◇◇
!◇◇◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◇◇◇◇◇◇◆◆◆◆◆◆◆◆◆◆◆◆◆◇◇◇◇◇◇◆◆◆◆◆◆◇◆◆◆◆◆◆◆◆◆◇◇◇
!◇◇◆◆◆◆◆◆◇◇◇◇◇◆◆◆◆◆◇◇◇◇◇◇◇◆◆◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◆◆◆◇◆◆◆◆◆◆◆◆◆◆◆◆◇◇◇
!◇◇◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◇◇◇◇◇◇◇◆◆◆◆◆◆◆◆◆◆◆◆◆◇◇◇◇◇◇◆◆◆◇◇◆◆◆◆◆◇◇◇◇◆◆◇◇◇
!◇◇◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◆◇◇◇◇◇◇◇◆◆◆◆◆◆◆◆◆◆◆◆◆◆◇◇◇◇◇◆◆◆◇◇◆◆◆◆◆◇◇◇◇◆◆◇◇◇
!◇◇◇◆◆◆◇◆◆◆◆◆◆◇◇◆◆◇◇◇◇◇◇◇◇◆◆◆◆◇◇◇◇◇◇◇◆◆◆◇◇◇◇◇◆◆◆◆◆◆◆◆◆◆◇◇◇◇◆◆◇◇◇
!◇◇◇◇◆◆◆◆◆◆◇◆◆◆◆◆◆◇◇◇◇◇◇◇◆◆◆◆◆◇◇◇◇◇◇◇◆◆◇◇◇◇◇◇◆◆◆◆◆◆◆◆◆◆◇◇◇◇◆◆◇◇◇
!◇◇◇◇◆◆◆◆◆◆◇◇◆◆◆◆◇◇◇◇◇◇◇◇◆◆◆◆◆◇◇◇◇◇◇◇◆◆◇◇◇◇◇◇◆◆◆◆◆◆◇◆◆◆◆◆◆◆◆◆◇◇◇
!◇◇◇◇◆◆◆◆◆◆◆◇◆◆◆◆◇◇◇◇◇◇◇◆◆◆◇◆◆◆◆◆◆◆◆◆◆◆◇◇◇◇◇◇◆◆◆◇◇◇◇◆◆◆◆◆◆◆◆◆◆◇◇
!◇◆◆◆◆◆◆◇◆◆◆◆◆◆◆◆◆◆◆◆◇◇◇◆◆◆◇◆◆◆◆◆◆◆◆◆◆◆◆◇◇◇◇◇◆◆◆◇◇◇◇◆◆◆◇◇◇◇◆◆◆◇◇
!◇◇◆◆◆◆◇◇◇◆◆◆◆◇◇◆◆◆◆◇◇◇◇◆◆◇◇◆◆◇◇◇◇◇◇◇◆◆◆◇◇◇◇◇◆◆◆◇◇◇◇◆◆◆◇◇◇◇◆◆◇◇◇
!◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇
!◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇    长安大学——聂启阳   ◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇ 
!◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇       2018年10月     ◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇ 
!◇◇    程序基于《一种融合Priority-Flood算法与D8算法特点的河网提取方式》   ◇◇
!◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇

    MODULE GongYongShuZu                        !**模块置于引用之前编译**
        
        REAL,ALLOCATABLE  ::  DuiLie(:,:)
    ! 后期定义个3*n的数组，第一行存值，第二行存x坐标，第三行存y坐标。
    ! 注意：由于是用的浮点数矩阵，取用x，y坐标时需要进行取整运算int()。
    ! DuiLie：最小优先队列。

        INTEGER,ALLOCATABLE  ::  DEM(:,:),FillDEM(:,:)
        INTEGER  ::  hang,lie,gc
    ENDMODULE    
    
    
Module CMD_Progress !进度条模块
  Implicit None
  private
  Logical , parameter , public :: CMD_PROGRESS_ABSOLUTE = .true.
  Type , public :: CLS_CMD_Progress
    Integer , private :: N , lens , i
    Character :: M = "#" , O = " "
    Character(len=64) :: Prefix
  Contains
    Procedure :: Set
    Procedure :: Put
  End Type CLS_CMD_Progress
  
contains

  Subroutine Set( this , N , L )
    Class( CLS_CMD_Progress ) :: this
    Integer , Intent( IN ) :: N , L
    this % N    = N
    this % lens = L
    this % i = 0
    this % Prefix = " 处理进度 : " 
  End Subroutine Set
  
  Subroutine Put( this , K , bAbsol )
    Class( CLS_CMD_Progress ) :: this
    Integer , Intent( IN ) :: K
    Logical , optional :: bAbsol
    Character(len=1) :: br
    integer :: jm
    this % i = this % i + K
    if ( present( bAbsol ) ) then
      if ( bAbsol ) this % i = K
    end if
    if ( this % i > this % n ) this % i = this % n    
    jm = Nint( real( this%i * this%lens ) / real( this%N ) )
    if ( this%i < this%n ) then
      br = char(13)
    else
      br = char(10)
    end if   
    write( * , '(5a,f6.2,2a\)') trim(this%Prefix) , '[' , & 
      repeat(this%M , jm ) , repeat( this%O , this%lens-jm ) , '] ' , this%i*100.0/this%N , "%" , br
  End Subroutine Put
  
End Module CMD_Progress
        
    program YouXianHongShuiFillDEM
    use GongYongShuZu
    use CMD_Progress
        implicit none
        
        type( CLS_CMD_Progress ) ::Progress
        REAL YaRu,Tanchu
        INTEGER i,j,m,n,xx,yy,ge,chang
        CHARACTER DATE
        CHARACTER(len=30) DATE1,DATE2,DATE3,DATE4,DATE5,DATE6
        REAL gaocha,gcc
        ALLOCATE (DuiLie(3,0:10000000))
        DuiLie=-8888
        DuiLie(1,0)=0

        !每个DuiLie数组（1，0）位存放有效大小，可以由此为判断数组是否不够用再扩大。
        !以减少动态数组反复操作时间，加快程序速度。
        
        OPEN (111,FILE='dem.txt')
        OPEN (222,FILE='FillDEM.txt')

        READ (111,'(A30)') DATE1
        READ (111,'(A30)') DATE2
        READ (111,'(A30)') DATE3
        READ (111,'(A30)') DATE4
        READ (111,'(A30)') DATE5
        READ (111,'(A30)') DATE6
        CLOSE (111)
        !读取栅格文件信息表头，为之后输出栅格图做准备。
        OPEN (111,FILE='dem.txt')
			READ (111,*) DATE,lie	!读取总列数
			READ (111,*) DATE,hang	!读取总行数
            READ (111,*)
            READ (111,*)
			READ (111,*) DATE,gc	!网格边长
            READ (111,*)
        allocate (DEM(hang,lie),FillDEM(hang,lie))
        
        DO m=1,hang
            READ (111,*) (DEM(m,n),n=1,lie)
        END DO
        DO n=1,lie
            DO m=1,hang
                FillDEM(m,n)=-9999
                if(DEM(m,n)>=0)then
                    xx=m
                    yy=n
                    call BianJiePanDuan(xx,yy)                             
                end if               
            END DO
        END DO
        write(*,*)'**********  开始计算  **********'
!◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇        
!◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇  计算核心  ◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇
!◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇ 
        chang=6*(hang+lie)
        call Progress % Set( N = chang , L = 50 )
        DO WHILE (duilie(1,0)>0)
            
                call ZuiXiaoTan(TanChu,xx,yy)
                Call LinYuPanDuan(xx,yy)
                ge=chang-DuiLie(1,0)
                Call Progress % Put( ge, CMD_PROGRESS_ABSOLUTE ) !// 绝对方式
                
        END DO
        
        WRITE (222,'(A30)') DATE1
        WRITE (222,'(A30)') DATE2
        WRITE (222,'(A30)') DATE3
        WRITE (222,'(A30)') DATE4
        WRITE (222,'(A30)') DATE5
        WRITE (222,'(A30)') DATE6
   
        do i = 1,hang
            write(222,'(<lie>I7)') (FillDEM(i,j), j = 1,lie)
        enddo
        write(*,*)'##########    成功    ##########'
        CLOSE (111) 
        CLOSE (222) 
        
        DEALLOCATE (DuiLie)
        DEALLOCATE (dem,FillDEM)
    end program YouXianHongShuiFillDEM

!◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇ 子程序 ◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇◇
      
    subroutine ZuiXiaoJia(YaRu,xx,yy)
    use GongYongShuZu
    implicit none
  
        real YaRu
        integer i,xx,yy  
        
        i=DuiLie(1,0)
  
        DuiLie(1,i+1)=YaRu
        DuiLie(2,i+1)=xx
        DuiLie(3,i+1)=yy
        
        DuiLie(1,0)=DuiLie(1,0)+1
            
    return
    end subroutine ZuiXiaoJia    
    
    subroutine ZuiXiaoTan(TanChu,xx,yy)   
    use GongYongShuZu
    implicit none
    ! 最小优先队列的弹出操作子函数，最小优先队列的排序将新最小值置于末尾并进行弹出并缩短操作。
    ! i:DuiLie长度。TanChu：弹出队列的数值。xx：弹出队列数值的x坐标。yy：弹出队列数值的y坐标。
    
        real TanChu,Mini(1,3)
        integer i,j,xx,yy
        integer,ALLOCATABLE  ::  ZuiXiao(:)
        
        ALLOCATE (ZuiXiao(1))
        
        i=DuiLie(1,0)  
        
        ZuiXiao=MinLoc(DuiLie(1,1:i))
        
        j=ZuiXiao(1)
        
        Mini(1,1)=DuiLie(1,j)
        Mini(1,2)=DuiLie(2,j)
        Mini(1,3)=DuiLie(3,j)
        
        DuiLie(1,j)=DuiLie(1,i)
        DuiLie(2,j)=DuiLie(2,i)
        DuiLie(3,j)=DuiLie(3,i)
    
        TanChu=Mini(1,1)
        xx=Mini(1,2)
        yy=Mini(1,3)  
        
        DuiLie(1,0)=DuiLie(1,0)-1
              
    return
    end subroutine ZuiXiaoTan
        
    subroutine BianJiePanDuan(xx,yy) 
    use GongYongShuZu
        implicit none
        integer BianJie,xx,yy,m,n
        real YaRu
        
        BianJie=1
        DO m=xx-1,xx+1
            DO n=yy-1,yy+1
                if(m<=0.or.m>hang.or.n<=0.or.n>lie)then                                        
                    BianJie=0                    
                elseif(DEM(m,n)<0)then
                    BianJie=0
                endif                
            END DO
        END DO
        !用BianJie参数表征是否边界栅格，四周有超出图幅范围的和空值则为边界栅格。是边界则BinJie为0，非边界为1。
        if(BianJie==0)then
            YaRu=DEM(xx,yy)
            FillDEM(xx,yy)=DEM(xx,yy)
            call ZuiXiaoJia(YaRu,xx,yy)            
        end if
    return
    end subroutine BianJiePanDuan
        
    subroutine LinYuPanDuan(xx,yy) 
    use GongYongShuZu
        implicit none
          
        integer xx,yy,mm,nn
        real YaRu
        
        !当FillDEM值小于0时才表示这个网格没有定流向
        if(yy+1<=lie)then
            if(FillDEM(xx,yy+1)<0.and.DEM(xx,yy+1)>0)then
                if(DEM(xx,yy+1)>DEM(xx,yy))then 
                    mm=xx
                    nn=yy+1
                    YaRu=DEM(xx,yy+1)
                    FillDEM(xx,yy+1)=DEM(xx,yy+1)
                    call ZuiXiaoJia(YaRu,mm,nn)
                else
                    mm=xx
                    nn=yy+1
                    YaRu=DEM(xx,yy)
                    FillDEM(xx,yy+1)=DEM(xx,yy)
                    call ZuiXiaoJia(YaRu,mm,nn)
                endif            
            endif
        endif
        
        if(xx+1<=hang.and.yy+1<=lie)then
            if(FillDEM(xx+1,yy+1)<0.and.DEM(xx+1,yy+1)>0)then
                if(DEM(xx+1,yy+1)>DEM(xx,yy))then 
                    mm=xx+1
                    nn=yy+1
                    YaRu=DEM(xx+1,yy+1)
                    FillDEM(xx+1,yy+1)=DEM(xx+1,yy+1)
                    call ZuiXiaoJia(YaRu,mm,nn)
                else
                    mm=xx+1
                    nn=yy+1
                    YaRu=DEM(xx,yy)
                    FillDEM(xx+1,yy+1)=DEM(xx,yy)
                    call ZuiXiaoJia(YaRu,mm,nn)
                endif            
            endif
        endif
        
        if(xx+1<=hang)then
            if(FillDEM(xx+1,yy)<0.and.DEM(xx+1,yy)>0)then
                if(DEM(xx+1,yy)>DEM(xx,yy))then 
                    mm=xx+1
                    nn=yy
                    YaRu=DEM(xx+1,yy)
                    FillDEM(xx+1,yy)=DEM(xx+1,yy)
                    call ZuiXiaoJia(YaRu,mm,nn)
                else
                    mm=xx+1
                    nn=yy
                    YaRu=DEM(xx,yy)
                    FillDEM(xx+1,yy)=DEM(xx,yy)
                    call ZuiXiaoJia(YaRu,mm,nn)
                endif            
            endif
        endif
        
        if(xx+1<=hang.and.yy-1>0)then
            if(FillDEM(xx+1,yy-1)<0.and.DEM(xx+1,yy-1)>0)then
                if(DEM(xx+1,yy-1)>DEM(xx,yy))then
                    mm=xx+1
                    nn=yy-1
                    YaRu=DEM(xx+1,yy-1)
                    FillDEM(xx+1,yy-1)=DEM(xx+1,yy-1)
                    call ZuiXiaoJia(YaRu,mm,nn)
                else
                    mm=xx+1
                    nn=yy-1
                    YaRu=DEM(xx,yy)
                    FillDEM(xx+1,yy-1)=DEM(xx,yy)
                    call ZuiXiaoJia(YaRu,mm,nn)
                endif            
            endif
        endif
        
        if(yy-1>0)then
            if(FillDEM(xx,yy-1)<0.and.DEM(xx,yy-1)>0)then
                if(DEM(xx,yy-1)>DEM(xx,yy))then 
                    mm=xx
                    nn=yy-1
                    YaRu=DEM(xx,yy-1)
                    FillDEM(xx,yy-1)=DEM(xx,yy-1)
                    call ZuiXiaoJia(YaRu,mm,nn)
                else
                    mm=xx
                    nn=yy-1
                    YaRu=DEM(xx,yy)
                    FillDEM(xx,yy-1)=DEM(xx,yy)
                    call ZuiXiaoJia(YaRu,mm,nn)
                endif            
            endif
        endif
        
        if(xx-1>0.and.yy-1>0)then
            if(FillDEM(xx-1,yy-1)<0.and.DEM(xx-1,yy-1)>0)then
                if(DEM(xx-1,yy-1)>DEM(xx,yy))then 
                    mm=xx-1
                    nn=yy-1
                    YaRu=DEM(xx-1,yy-1)
                    FillDEM(xx-1,yy-1)=DEM(xx-1,yy-1)
                    call ZuiXiaoJia(YaRu,mm,nn)
                else
                    mm=xx-1
                    nn=yy-1
                    YaRu=DEM(xx,yy)
                    FillDEM(xx-1,yy-1)=DEM(xx,yy)
                    call ZuiXiaoJia(YaRu,mm,nn)
                endif            
            endif
        endif
        
        if(xx-1>0)then
            if(FillDEM(xx-1,yy)<0.and.DEM(xx-1,yy)>0)then
                if(DEM(xx-1,yy)>DEM(xx,yy))then
                    mm=xx-1
                    nn=yy
                    YaRu=DEM(xx-1,yy)
                    FillDEM(xx-1,yy)=DEM(xx-1,yy)
                    call ZuiXiaoJia(YaRu,mm,nn)
                else
                    mm=xx-1
                    nn=yy
                    YaRu=DEM(xx,yy)
                    FillDEM(xx-1,yy)=DEM(xx,yy)
                    call ZuiXiaoJia(YaRu,mm,nn)
                endif            
            endif
        endif
        
        if(xx-1>0.and.yy+1<lie)then
            if(FillDEM(xx-1,yy+1)<0.and.DEM(xx-1,yy+1)>0)then
                if(DEM(xx-1,yy+1)>DEM(xx,yy))then 
                    mm=xx-1
                    nn=yy+1
                    YaRu=DEM(xx-1,yy+1)
                    FillDEM(xx-1,yy+1)=DEM(xx-1,yy+1)
                    call ZuiXiaoJia(YaRu,mm,nn)
                else
                    mm=xx-1
                    nn=yy+1
                    YaRu=DEM(xx,yy)
                    FillDEM(xx-1,yy+1)=DEM(xx,yy)
                    call ZuiXiaoJia(YaRu,mm,nn)
                endif            
            endif
        endif
    
        return
    end subroutine LinYuPanDuan
